---
slug: /fp/3
description: 利用容器对控制流、异常处理、异步操作和副作用等进行函数式处理
---

### 容器与 functor

容器就是一个将数据包装起来的玻璃瓶，这个玻璃瓶内的数据类型可以是任意的，并且我们无法直接对容器内的数据进行操作

我们需要对容器内的数据进行操作时使用 map 方法进行操作，这让我们能够在不离开 container 的情况下操作里面的数据，同时还能够利用 compose 的能力连续调用，这就是一个 functor

functor 的概念是：

> functor 是实现了 map 函数并遵守一些特定规则的容器类型

functor 可以让容器自己运行一个函数，这是一种强大的抽象，统一了某一类范畴的具体操作

### 不同类型的 functor

#### 薛定谔的 Maybe

Maybe 是一个针对空值判断的 functor，利用 Maybe 可以对空值数据进行处理

#### ”纯“错误处理

Either 是一个针对错误处理的 functor，针对出错情况返回不同的消息提示用户，而不是像 throw 一样抛出一个错误从而导致不”纯“

#### 副作用处理

IO 是一个针对副作用处理的 functor，通过将所有副作用函数收集并提供用户触发副作用的接口，从而保证纯函数的概念

#### 异步任务处理

Task 是一个针对异步任务处理的 functor，提供收集方法并提供用户触发异步任务的接口

#### 练习

```typescript
require('../../support')
var Task = require('data.task')
var _ = require('ramda')

// 练习 1
// ==========
// 使用 _.add(x,y) 和 _.map(f,x) 创建一个能让 functor 里的值增加的函数

var ex1 = undefined
// highlight-start
//solution:
ex1 = _.map(_.add(1))
//highlight-end

//练习 2
// ==========
// 使用 _.head 获取列表的第一个元素
var xs = Identity.of([
  'do',
  'ray',
  'me',
  'fa',
  'so',
  'la',
  'ti',
  'do'
])

var ex2 = undefined
// highlight-start
//solution:
ex2 = _.map(_.head)
// highlight-end

// 练习 3
// ==========
// 使用 safeProp 和 _.head 找到 user 的名字的首字母
var safeProp = _.curry(function (x, o) {
  return Maybe.of(o[x])
})

var user = { id: 2, name: 'Albert' }

var ex3 = undefined
// highlight-start
//solution:
ex3 = _.compose(_.map(_.head), safeProp('name'))
// highlight-end

// 练习 4
// ==========
// 使用 Maybe 重写 ex4，不要有 if 语句

var ex4 = function (n) {
  if (n) {
    return parseInt(n)
  }
}

var ex4 = undefined
// highlight-start
//solution:
ex4 = function (n) {
  return _.map(parseInt, Maybe.of(n))
}
// highlight-end

// 练习 5
// ==========
// 写一个函数，先 getPost 获取一篇文章，然后 toUpperCase 让这片文章标题变为大写

// getPost :: Int -> Future({id: Int, title: String})
var getPost = function (i) {
  return new Task(function (rej, res) {
    setTimeout(function () {
      res({ id: i, title: 'Love them futures' })
    }, 300)
  })
}

var ex5 = undefined
// highlight-start
//solution:
ex5 = _.compose(_.map(_.toUpper), _.map(_.prop('title')), getPost)
// highlight-end

// 练习 6
// ==========
// 写一个函数，使用 checkActive() 和 showWelcome() 分别允许访问或返回错误

var showWelcome = _.compose(_.add('Welcome '), _.prop('name'))

var checkActive = function (user) {
  return user.active
    ? Right.of(user)
    : Left.of('Your account is not active')
}
var ex6 = undefined
// highlight-start
//solution:
ex6 = _.compose(_.map(showWelcome), checkActive)
// highlight-end

// 练习 7
// ==========
// 写一个验证函数，检查参数是否 length > 3。如果是就返回 Right(x)，否则就返回
// Left("You need > 3")

var ex7 = function (x) {
  return x.length > 3 ? Right.of(x) : Left.of('You need > 3')
}
// 练习 8
// ==========
// 使用练习 7 的 ex7 和 Either 构造一个 functor，如果一个 user 合法就保存它，否则
// 返回错误消息。别忘了 either 的两个参数必须返回同一类型的数据。

var save = function (x) {
  return new IO(function () {
    console.log('SAVED USER!')
    return x + '-saved'
  })
}
// highlight-start
//solution:
var either = _.curry(function (f, g, e) {
  switch (e.constructor) {
    case Left:
      return f(e.__value)
    case Right:
      return g(e.__value)
  }
})
var ex8 = (v) => {
  return either(IO.of, save)(ex7(v))
}
// highlight-end
```
